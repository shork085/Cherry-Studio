# 数据可视化模块集成指南

## 概述

这个模块将Vue数据可视化项目集成到Cherry Studio中，使用iframe方式实现快速集成和验证。

## 文件结构

```
src/renderer/src/pages/dataviz/
├── DataVizPage.tsx          # React页面组件，承载iframe
├── vue-app/                 # Vue应用目录
│   ├── vite.config.ts       # Vue应用的Vite配置
│   ├── package.json         # Vue应用依赖
│   ├── index.html           # Vue应用入口HTML
│   └── src/
│       ├── main.ts          # Vue应用入口
│       ├── App.vue          # Vue根组件
│       ├── router/          # Vue路由配置
│       └── views/           # Vue页面组件
│           ├── HomeView.vue
│           ├── formView.vue
│           └── formView_gl.vue
└── README.md               # 本文档
```

## 快速开始

### 1. 安装Vue应用依赖

```bash
cd src/renderer/src/pages/dataviz/vue-app
npm install
```

### 2. 开发模式运行

#### 启动Vue应用开发服务器
```bash
cd src/renderer/src/pages/dataviz/vue-app
npm run dev
```

#### 启动Cherry Studio
```bash
# 在项目根目录
yarn dev
```

### 3. 访问数据可视化页面

在Cherry Studio中，点击侧边栏的"数据可视化"图标，或直接访问 `/#/dataviz`

## 通信机制

### iframe到父窗口通信

Vue应用可以通过以下方式向Cherry Studio发送消息：

```javascript
// 通知应用已准备就绪
window.parent.postMessage({
  type: 'DATAVIZ_READY',
  data: { timestamp: Date.now() }
}, '*')

// 提交表单数据
window.parent.postMessage({
  type: 'FORM_SUBMIT',
  data: {
    name: 'example',
    email: 'test@example.com',
    // ... 其他数据
    timestamp: new Date().toISOString(),
    source: 'formView'
  }
}, '*')

// 请求数据
window.parent.postMessage({
  type: 'REQUEST_DATA',
  data: { source: 'home' }
}, '*')
```

### 父窗口到iframe通信

Cherry Studio可以向Vue应用发送数据：

```javascript
// 发送数据到Vue应用
iframeRef.current.contentWindow.postMessage({
  type: 'CHERRY_DATA',
  data: {
    // Cherry Studio的数据
  }
}, '*')
```

## 生产环境部署

### 1. 构建Vue应用

```bash
cd src/renderer/src/pages/dataviz/vue-app
npm run build
```

### 2. 配置静态文件服务

构建后的文件会生成在 `vue-app/dist` 目录，需要配置Electron的静态文件服务来提供这些文件。

### 3. 更新Electron配置

在 `electron.vite.config.ts` 中添加静态文件服务配置：

```typescript
// 在main配置中添加
static: {
  directory: resolve(__dirname, 'src/renderer/src/pages/dataviz/vue-app/dist'),
  publicPath: '/dataviz'
}
```

## 开发注意事项

1. **跨域问题**: 开发环境下，Vue应用运行在 `localhost:3001`，生产环境下使用相对路径
2. **消息安全**: 生产环境下应该验证消息来源
3. **错误处理**: iframe加载失败时会显示错误提示
4. **响应式设计**: Vue应用需要适配iframe容器的大小

## 后续优化

当iframe方案验证成功后，可以考虑以下优化：

1. **Vue微前端集成**: 使用 `@vue/react-integration` 将Vue组件直接集成到React中
2. **状态管理**: 集成Vuex/Pinia与Cherry Studio的状态管理
3. **主题同步**: 同步Cherry Studio的主题到Vue应用
4. **数据服务**: 集成Cherry Studio的数据服务API

## 故障排除

### Vue应用无法加载
- 检查Vue开发服务器是否运行在3001端口
- 检查控制台是否有跨域错误
- 确认iframe的src路径是否正确

### 消息通信失败
- 检查消息格式是否正确
- 确认消息类型是否匹配
- 查看控制台是否有错误信息

### 样式问题
- 检查Vue应用的CSS是否与Cherry Studio冲突
- 确认iframe的sandbox属性设置
- 检查响应式布局是否正常
